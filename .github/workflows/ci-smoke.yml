name: CI Smoke

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch: {}

concurrency:
  group: ci-smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 20

    env:
      AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
      API_KEY: ${{ secrets.API_KEY }}
      API_KEY_ORG_ID: ${{ secrets.API_KEY_ORG_ID }}
      QDRANT_URI: ${{ secrets.QDRANT_URI }}
      QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
      NEO4J_URI: ${{ secrets.NEO4J_URI }}
      NEO4J_USERNAME: ${{ secrets.NEO4J_USERNAME }}
      NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
      POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
      AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}

      # Backend runtime
      REDIS_URL: redis://127.0.0.1:6379/0
      PORT: "8000"
      BASE_URL: http://127.0.0.1:8000

      # Enforce strict behavior in CI
      ARTIFACTS_ALLOW_LOCAL_FALLBACK: "false"
      ALLOW_BLOB_LEGACY_READ: "false"
      ALLOW_ORGLESS_TASKS: "false"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
              # Prefer editable install from the backend folder if packaging metadata exists there
              if [ -f backend/pyproject.toml ] || [ -f backend/setup.cfg ] || [ -f backend/setup.py ]; then
                pip install -e backend
              fi
              # Fallback: install backend requirements and top-level requirements
              if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Start backend
        run: |
          set -euo pipefail
          # Ensure required secrets are present before starting heavy checks
          if [ -z "${QDRANT_URI:-}" ] || [ -z "${POSTGRES_HOST:-}" ]; then
            echo "Required service secrets (QDRANT_URI, POSTGRES_HOST, ...) are missing."
            echo "Please add them to repository secrets to run full CI smoke checks."
            exit 1
          fi
          nohup uvicorn backend.app:app --host 0.0.0.0 --port 8000 > backend-ci.log 2>&1 &
          echo $! > backend.pid

      - name: Wait for healthz
        run: |
          set -euo pipefail
          for i in $(seq 1 60); do
            if curl -fsS "$BASE_URL/healthz" >/dev/null; then
              echo "Backend is healthy."
              exit 0
            fi
            sleep 1
          done
          echo "Backend did not become healthy in time."
          echo "=== backend-ci.log ==="
          tail -n 300 backend-ci.log || true
          exit 1

      - name: Run CI smoke script
        run: |
          set -euo pipefail
          # Try scripts path first, then repo root
          if [ -f ./scripts/ci_smoke.sh ]; then
            chmod +x ./scripts/ci_smoke.sh
            ./scripts/ci_smoke.sh
          elif [ -f ./ci_smoke.sh ]; then
            chmod +x ./ci_smoke.sh
            ./ci_smoke.sh
          else
            echo "ci_smoke.sh not found in ./scripts or repo root"
            exit 1
          fi

      - name: Upload backend logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-ci-logs
          path: |
            backend-ci.log
            **/*smoke*.log
          if-no-files-found: ignore

      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill "$(cat backend.pid)" || true
          fi